<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Compact Master Database</title>
    <style>
        :root { --primary: #2080b0; --bg: #f4f7f6; --border: #e0e0e0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
        .container { background: white; padding: 12px; border-radius: 6px; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h2 { margin: 0; font-size: 18px; color: var(--primary); }

        .stats-grid { display: flex; gap: 10px; margin-bottom: 10px; }
        .stat-card { flex: 1; padding: 8px; border-radius: 4px; color: white; text-align: center; min-width: 120px; }
        .stat-card h3 { margin: 0; font-size: 18px; }
        .stat-card p { margin: 0; font-size: 11px; font-weight: bold; }

        #searchInput { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; box-sizing: border-box; }

        /* Compact Table Logic */
        .table-wrap { 
            overflow: auto; 
            max-height: 75vh; 
            border: 1px solid var(--border); 
            background: white; 
        }
        
        table { 
            border-collapse: separate; 
            border-spacing: 0; 
            font-size: 11.5px; 
            width: max-content; /* Critical: Table only takes as much space as text needs */
        }

        th, td { 
            padding: 6px 12px; 
            border-bottom: 1px solid var(--border); 
            border-right: 1px solid var(--border);
            white-space: nowrap; 
            text-align: left;
        }

        /* Sticky Header */
        th { 
            background: #f8f9fa; 
            position: sticky; 
            top: 0; 
            z-index: 20; 
            font-weight: 600;
            color: #555;
            box-shadow: inset 0 -1px 0 var(--border);
        }

        /* Sticky First Column (Order of Purchase) */
        td:first-child, th:first-child {
            position: sticky;
            left: 0;
            z-index: 10;
            background: #fff;
            border-right: 2px solid var(--border);
        }
        th:first-child { z-index: 30; background: #f8f9fa; }

        tr:hover td { background: #f0f7ff !important; }

        /* Specific Widths for long text columns */
        .col-address { white-space: normal; width: 200px; max-width: 250px; font-size: 10.5px; }
        .col-product { white-space: normal; width: 180px; max-width: 220px; }

        .tag { padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>ðŸ“‘ Compact Master Sales Database</h2>
        <button onclick="loadData()" style="padding:4px 10px; cursor:pointer;">Refresh</button>
    </div>

    <div class="stats-grid">
        <div class="stat-card" style="background:#2080b0;"><h3 id="t1">0</h3><p>TOTAL ENTRIES</p></div>
        <div class="stat-card" style="background:#27ae60;"><h3 id="t2">0</h3><p>GOOGLE FORM</p></div>
        <div class="stat-card" style="background:#f39c12;"><h3 id="t3">0</h3><p>ACTIVE STATUS</p></div>
    </div>

    <input type="text" id="searchInput" placeholder="Search by any field..." onkeyup="filterData()">

    <div class="table-wrap">
        <table id="masterTable">
            <thead>
                <tr>
                    <th>Order of Purchase</th>
                    <th>Purchase Date</th>
                    <th>Entry By</th>
                    <th>Source</th>
                    <th>Sold-By</th>
                    <th>Order ID</th>
                    <th>Customer Name</th>
                    <th>Email</th>
                    <th>Address</th>
                    <th>Product Name</th>
                    <th>ASIN</th>
                    <th>Invoice No.</th>
                    <th>Mobile</th>
                    <th>Option 1</th>
                    <th>Option 0</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS2kyBpEWbTdDbogAQd-tCp2LupNSVmS238MINv1eZJ8UyHtId8sMBvNrvA49wH8XQ_-K0lLvw3gK82/pub?output=csv';
    let rawData = [];

    async function loadData() {
        try {
            const res = await fetch(csvUrl + '&cb=' + Date.now());
            const text = await res.text();
            rawData = text.trim().split('\n').slice(1).map(line => {
                const c = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                return {
                    a: (c[0]||'').replace(/"/g,''), b: (c[1]||'').replace(/"/g,''),
                    c: (c[2]||'').replace(/"/g,''), d: (c[3]||'').replace(/"/g,''),
                    e: (c[4]||'').replace(/"/g,''), f: (c[5]||'').replace(/"/g,''),
                    g: (c[6]||'').replace(/"/g,''), h: (c[7]||'').replace(/"/g,''),
                    i: (c[8]||'').replace(/"/g,''), j: (c[9]||'').replace(/"/g,''),
                    k: (c[10]||'').replace(/"/g,''), l: (c[11]||'').replace(/"/g,''),
                    m: (c[12]||'').replace(/"/g,''), n: (c[13]||'').replace(/"/g,''),
                    o: (c[14]||'').replace(/"/g,''), p: (c[15]||'').replace(/"/g,'')
                };
            }).filter(x => x.f || x.g);
            render(rawData);
        } catch (e) { console.error(e); }
    }

    function filterData() {
        const val = document.getElementById('searchInput').value.toLowerCase();
        const filtered = rawData.filter(r => Object.values(r).some(v => v.toLowerCase().includes(val)));
        render(filtered, true);
    }

    function render(data, isFilt = false) {
        const body = document.getElementById('tableBody');
        body.innerHTML = data.map(r => `
            <tr>
                <td>${r.a}</td><td>${r.b}</td><td>${r.c}</td><td>${r.d}</td><td>${r.e}</td>
                <td style="color:#2080b0; font-weight:600;">${r.f}</td>
                <td>${r.g}</td><td>${r.h}</td>
                <td class="col-address">${r.i}</td>
                <td class="col-product">${r.j}</td>
                <td>${r.k}</td><td>${r.l}</td><td>${r.m}</td><td>${r.n}</td><td>${r.o}</td>
                <td><span class="tag" style="background:${getClr(r.p)}">${r.p}</span></td>
            </tr>
        `).join('');
        if(!isFilt) {
            document.getElementById('t1').innerText = data.length;
            document.getElementById('t2').innerText = data.filter(x => x.d.toUpperCase().includes('GOOGLE')).length;
            document.getElementById('t3').innerText = data.filter(x => ['YES','REP','DONE'].includes(x.p.toUpperCase())).length;
        }
    }

    function getClr(s) {
        const v = s.toUpperCase();
        if(v==='YES'||v==='DONE') return '#d4edda';
        if(v==='REP'||v==='SEND LINK') return '#fff3cd';
        if(v.includes('NOT')) return '#f8d7da';
        return '#eee';
    }
    window.onload = loadData;
</script>
</body>
</html>
