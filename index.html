<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Master Order Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2080b0; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 100%; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .status-pill { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        
        /* Summary Section */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { padding: 15px; border-radius: 8px; color: white; text-align: center; }
        .bg-blue { background: #2080b0; }
        .bg-green { background: #27ae60; }
        .bg-orange { background: #f39c12; }

        #searchInput { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; margin-bottom: 20px; outline: none; }
        #searchInput:focus { border-color: var(--primary); }

        /* Table Styling - Handling 16 Columns */
        .table-container { overflow-x: auto; max-height: 600px; border: 1px solid #ddd; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; white-space: nowrap; }
        th { background: #f8f9fa; color: #333; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; z-index: 10; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f1f8ff; }
        
        .busy-tag { padding: 3px 8px; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ðŸ“‘ Master Sales Database</h1>
        <div>
            <span id="syncStatus" class="status-pill" style="background: #ffeeba;">Syncing...</span>
            <button onclick="loadData()" style="margin-left:10px; cursor:pointer;">ðŸ”„ Refresh</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card bg-blue"><h2 id="totalOrders">0</h2><p>Total Entries</p></div>
        <div class="stat-card bg-green"><h2 id="totalGoogle">0</h2><p>Source: Google Form</p></div>
        <div class="stat-card bg-orange"><h2 id="totalBusy">0</h2><p>Status: YES/REP</p></div>
    </div>

    <input type="text" id="searchInput" placeholder="ðŸ” Search any column (Order ID, Name, Email, ASIN, Status...)" onkeyup="filterData()">

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Order of Purchase</th>
                    <th>Purchase Date</th>
                    <th>Entry By</th>
                    <th>Source</th>
                    <th>Sold-By</th>
                    <th>Order ID</th>
                    <th>Customer Name</th>
                    <th>Email</th>
                    <th>Address</th>
                    <th>Product Name</th>
                    <th>ASIN</th>
                    <th>Invoice No.</th>
                    <th>Mobile Number</th>
                    <th>Option 1</th>
                    <th>Option 0</th>
                    <th>Busy/Status</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="16" style="text-align:center; padding:50px;">Initializing connection to your Google Sheet...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS2kyBpEWbTdDbogAQd-tCp2LupNSVmS238MINv1eZJ8UyHtId8sMBvNrvA49wH8XQ_-K0lLvw3gK82/pub?output=csv';
    let allData = [];

    async function loadData() {
        const status = document.getElementById('syncStatus');
        try {
            const response = await fetch(csvUrl + '&cache=' + new Date().getTime());
            const text = await response.text();
            allData = parseCSV(text);
            renderUI(allData);
            status.innerText = "â— LIVE";
            status.style.background = "#d4edda";
            status.style.color = "#155724";
        } catch (err) {
            status.innerText = "OFFLINE";
            status.style.background = "#f8d7da";
        }
    }

    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        return lines.slice(1).map(line => {
            // Regex to handle commas inside quotes in addresses
            const cells = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            return {
                a: (cells[0] || "").replace(/"/g, '').trim(), // Order of Purchase
                b: (cells[1] || "").replace(/"/g, '').trim(), // Purchase Date
                c: (cells[2] || "").replace(/"/g, '').trim(), // Entry By
                d: (cells[3] || "").replace(/"/g, '').trim(), // Source
                e: (cells[4] || "").replace(/"/g, '').trim(), // Sold-By
                f: (cells[5] || "").replace(/"/g, '').trim(), // Order ID
                g: (cells[6] || "").replace(/"/g, '').trim(), // Customer Name
                h: (cells[7] || "").replace(/"/g, '').trim(), // Email
                i: (cells[8] || "").replace(/"/g, '').trim(), // Address
                j: (cells[9] || "").replace(/"/g, '').trim(), // Product Name
                k: (cells[10] || "").replace(/"/g, '').trim(), // ASIN
                l: (cells[11] || "").replace(/"/g, '').trim(), // Invoice No
                m: (cells[12] || "").replace(/"/g, '').trim(), // Mobile
                n: (cells[13] || "").replace(/"/g, '').trim(), // Option 1
                o: (cells[14] || "").replace(/"/g, '').trim(), // Option 0
                p: (cells[15] || "").replace(/"/g, '').trim()  // Busy/Status
            };
        }).filter(row => row.f !== ""); // Filter out empty Order ID rows
    }

    function filterData() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allData.filter(row => 
            Object.values(row).some(val => val.toLowerCase().includes(term))
        );
        renderUI(filtered, true);
    }

    function renderUI(data, isFiltering = false) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = data.map(r => `
            <tr>
                <td>${r.a}</td>
                <td>${r.b}</td>
                <td>${r.c}</td>
                <td>${r.d}</td>
                <td>${r.e}</td>
                <td><strong>${r.f}</strong></td>
                <td>${r.g}</td>
                <td>${r.h}</td>
                <td title="${r.i}">${r.i.length > 30 ? r.i.substring(0,30)+'...' : r.i}</td>
                <td>${r.j}</td>
                <td>${r.k}</td>
                <td>${r.l}</td>
                <td>${r.m}</td>
                <td>${r.n}</td>
                <td>${r.o}</td>
                <td><span class="busy-tag" style="background:${getStatusColor(r.p)}">${r.p}</span></td>
            </tr>
        `).join('');

        if(!isFiltering) {
            document.getElementById('totalOrders').innerText = data.length;
            document.getElementById('totalGoogle').innerText = data.filter(x => x.d.toUpperCase().includes('GOOGLE')).length;
            document.getElementById('totalBusy').innerText = data.filter(x => ['YES','REP','DONE'].includes(x.p.toUpperCase())).length;
        }
    }

    function getStatusColor(status) {
        const s = status.toUpperCase();
        if(s === 'YES' || s === 'DONE') return '#d4edda';
        if(s === 'REP' || s === 'SEND LINK') return '#fff3cd';
        if(s.includes('NOT')) return '#f8d7da';
        return '#eee';
    }

    window.onload = loadData;
</script>

</body>
</html>
